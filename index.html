<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è§†é¢‘åˆ†äº«å¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .banner-link {
            display: block;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .banner-link img {
            width: 100%;
            display: block;
        }
        
        .player-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        
        #videoPlayer {
            width: 100%;
            height: 280px;
            display: block;
            object-fit: contain;
        }
        
        .player-tip {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        
        .video-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .video-info h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .video-info p {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .watch-count {
            display: flex;
            align-items: center;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .watch-count .icon {
            width: 24px;
            height: 24px;
            background: #2196f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-size: 12px;
        }
        
        .video-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .video-list h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #ff4081;
        }
        
        .video-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .video-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .video-item:hover {
            background: #f0f0f0;
        }
        
        .video-item.active {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        .video-item.played {
            opacity: 0.7;
        }
        
        .video-item .thumb {
            width: 60px;
            height: 45px;
            background: #ddd;
            border-radius: 4px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
            overflow: hidden;
        }
        
        .video-item .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-item .info {
            flex-grow: 1;
        }
        
        .video-item .title {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .video-item .duration {
            font-size: 12px;
            color: #666;
        }
        
        .share-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding: 20px 15px 30px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .share-panel.active {
            transform: translateY(0);
        }
        
        .share-panel h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
        }
        
        .share-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .share-option .icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 24px;
        }
        
        .share-option .text {
            font-size: 12px;
            color: #333;
        }
        
        .share-option.wechat .icon {
            background: #09bb07;
            color: white;
        }
        
        .share-option.moments .icon {
            background: #7bc549;
            color: white;
        }
        
        .share-option.save .icon {
            background: #2196f3;
            color: white;
        }
        
        .share-option.collect .icon {
            background: #ff9800;
            color: white;
        }
        
        .cancel-btn {
            width: 100%;
            padding: 12px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }
        
        .share-guide {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .share-guide.active {
            display: flex;
        }
        
        .share-guide img {
            width: 200px;
            height: 200px;
            margin-bottom: 20px;
            border: 2px solid white;
            border-radius: 10px;
            object-fit: cover;
        }
        
        .share-guide p {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .share-guide .close-guide {
            margin-top: 20px;
            padding: 10px 20px;
            background: #ff4081;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .options-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .options-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #ff9800;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .option-item {
            background: #fff3e0;
            border-radius: 6px;
            padding: 12px 8px;
            text-align: center;
            border-left: 3px solid #ff9800;
        }
        
        .option-item .icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .option-item .text {
            font-size: 12px;
            color: #333;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            font-size: 12px;
            color: #999;
            margin-top: 20px;
        }
        
        .locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            border-radius: 8px;
        }
        
        .locked-overlay .lock-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .locked-overlay p {
            margin-bottom: 15px;
            text-align: center;
            padding: 0 20px;
        }
        
        .unlock-btn {
            padding: 10px 20px;
            background: #ff4081;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .hidden {
            display: none;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        .video-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>è§†é¢‘åˆ†äº«å¹³å°</h1>
        <p>ç²¾å½©è§†é¢‘å…è´¹çœ‹ï¼Œåˆ†äº«å¥½å‹è§£é”æ›´å¤š</p>
    </div>
    
    <!-- å¯è‡ªå®šä¹‰çš„è¶…é“¾æ¥å›¾ç‰‡ -->
    <a href="#" class="banner-link">
        <img src="https://via.placeholder.com/500x100/4CAF50/FFFFFF?text=è‡ªå®šä¹‰å¹¿å‘Šå›¾ç‰‡" alt="å¹¿å‘Šå›¾ç‰‡">
    </a>
    
    <div class="player-container">
        <video id="videoPlayer" controls playsinline webkit-playsinline x5-playsinline x-webkit-airplay="allow">
            <!-- å¾®ä¿¡æµè§ˆå™¨éœ€è¦è¿™äº›å±æ€§æ‰èƒ½æ­£å¸¸æ’­æ”¾ -->
        </video>
        
        <div id="lockedOverlay" class="locked-overlay hidden">
            <div class="lock-icon">ğŸ”’</div>
            <p>æ‚¨å·²è§‚çœ‹å®Œ3ä¸ªå…è´¹è§†é¢‘ï¼Œåˆ†äº«ç»™å¥½å‹å³å¯è§£é”æ›´å¤šå†…å®¹</p>
            <button class="unlock-btn" id="showShareBtn">ç«‹å³åˆ†äº«</button>
        </div>
        
        <div id="videoLoading" class="video-loading hidden">
            è§†é¢‘åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...
        </div>
    </div>
    
    <div class="player-tip">
        æ¸©é¦¨æç¤ºï¼šè§†é¢‘åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…
    </div>
    
    <div class="video-info">
        <h2 id="currentVideoTitle">è¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ’­æ”¾</h2>
        <p>é˜²èµ°ä¸¢æç¤ºå¦‚æ— æ³•æ‰“å¼€ï¼Œæ¢ä¸€éƒ¨ä½œå“åˆ†äº«ç»™è£™å‹</p>
        <div class="watch-count">
            <div class="icon">!</div>
            <div>å½“å‰å‘¨æœŸå·²è§‚çœ‹: <span id="watchedCount">0</span>/3 ä¸ªå…è´¹è§†é¢‘</div>
        </div>
    </div>
    
    <div class="video-list">
        <h3>è§†é¢‘åˆ—è¡¨</h3>
        <div class="video-items" id="videoItems">
            <!-- è§†é¢‘åˆ—è¡¨ä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <div class="options-section">
        <h3>ç²¾é€‰å†…å®¹æ¨è</h3>
        <div class="options-grid">
            <div class="option-item">
                <div class="icon">ğŸ“º</div>
                <div class="text">çƒ­é—¨ç›´æ’­</div>
            </div>
            <div class="option-item">
                <div class="icon">ğŸ¬</div>
                <div class="text">æœ€æ–°å½±è§†</div>
            </div>
            <div class="option-item">
                <div class="icon">ğŸµ</div>
                <div class="text">éŸ³ä¹MV</div>
            </div>
            <div class="option-item">
                <div class="icon">ğŸ®</div>
                <div class="text">æ¸¸æˆè§†é¢‘</div>
            </div>
            <div class="option-item">
                <div class="icon">ğŸ“±</div>
                <div class="text">çŸ­è§†é¢‘</div>
            </div>
            <div class="option-item">
                <div class="icon">ğŸ”¥</div>
                <div class="text">çƒ­é—¨æ¨è</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Â© 2025 è§†é¢‘åˆ†äº«å¹³å° Â· ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨</p>
    </div>
    
    <!-- åˆ†äº«é¢æ¿ -->
    <div class="share-panel" id="sharePanel">
        <h3>éœ€è¦åˆ†äº«åæ‰èƒ½ç»§ç»­è§‚å½±</h3>
        <div class="share-options">
            <div class="share-option wechat" id="shareToFriend">
                <div class="icon">ğŸ‘¤</div>
                <div class="text">è½¬å‘ç»™æœ‹å‹</div>
            </div>
            <div class="share-option moments" id="shareToMoments">
                <div class="icon">ğŸ‘¥</div>
                <div class="text">åˆ†äº«åˆ°æœ‹å‹åœˆ</div>
            </div>
            <div class="share-option save" id="saveToPhone">
                <div class="icon">ğŸ’¾</div>
                <div class="text">ä¿å­˜åˆ°æ‰‹æœº</div>
            </div>
            <div class="share-option collect" id="collectBtn">
                <div class="icon">â­</div>
                <div class="text">æ”¶è—</div>
            </div>
        </div>
        <button class="cancel-btn" id="cancelShare">å–æ¶ˆ</button>
    </div>
    
    <!-- åˆ†äº«æŒ‡å¼• -->
    <div class="share-guide" id="shareGuide">
        <img src="https://i.ibb.co/Z63h8mck/qrcode.png" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
        <p>è¯·ç‚¹å‡»å³ä¸Šè§’"..."æŒ‰é’®</p>
        <p>ç„¶åé€‰æ‹©"å‘é€ç»™æœ‹å‹"æˆ–"åˆ†äº«åˆ°æœ‹å‹åœˆ"</p>
        <button class="close-guide" id="closeGuide">æˆ‘å·²åˆ†äº«</button>
    </div>
    
    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å˜é‡
            let watchedCount = 0;
            let hasShared = false;
            let currentVideoId = null;
            let playedVideos = new Set(); // ä½¿ç”¨Setæ¥è®°å½•å·²æ’­æ”¾çš„è§†é¢‘ï¼Œé¿å…é‡å¤è®¡æ•°
            let cycleCount = 0; // è®°å½•å½“å‰æ˜¯ç¬¬å‡ ä¸ªå‘¨æœŸ
            
            const videoPlayer = document.getElementById('videoPlayer');
            const watchedCountElement = document.getElementById('watchedCount');
            const lockedOverlay = document.getElementById('lockedOverlay');
            const showShareBtn = document.getElementById('showShareBtn');
            const videoItemsContainer = document.getElementById('videoItems');
            const currentVideoTitle = document.getElementById('currentVideoTitle');
            const sharePanel = document.getElementById('sharePanel');
            const overlay = document.getElementById('overlay');
            const shareGuide = document.getElementById('shareGuide');
            const shareToFriend = document.getElementById('shareToFriend');
            const shareToMoments = document.getElementById('shareToMoments');
            const saveToPhone = document.getElementById('saveToPhone');
            const collectBtn = document.getElementById('collectBtn');
            const cancelShare = document.getElementById('cancelShare');
            const closeGuide = document.getElementById('closeGuide');
            const videoLoading = document.getElementById('videoLoading');
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è§‚çœ‹æ¬¡æ•°
            const savedWatchedCount = localStorage.getItem('watchedCount');
            if (savedWatchedCount !== null) {
                watchedCount = parseInt(savedWatchedCount);
                watchedCountElement.textContent = watchedCount;
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åˆ†äº«çŠ¶æ€
            const savedHasShared = localStorage.getItem('hasShared');
            if (savedHasShared !== null) {
                hasShared = JSON.parse(savedHasShared);
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å·²æ’­æ”¾è§†é¢‘
            const savedPlayedVideos = localStorage.getItem('playedVideos');
            if (savedPlayedVideos !== null) {
                playedVideos = new Set(JSON.parse(savedPlayedVideos));
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å‘¨æœŸè®¡æ•°
            const savedCycleCount = localStorage.getItem('cycleCount');
            if (savedCycleCount !== null) {
                cycleCount = parseInt(savedCycleCount);
            }
            
            // åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„å¤šæ¡M3U8é“¾æ¥
            const videoList = [
                {
                    id: 1,
                    title: "ç¤ºä¾‹è§†é¢‘1 - é£æ™¯æ¬£èµ",
                    url: "https://v202509.fhbbff.com/20251025/YvivGiif/index.m3u8", // ä½¿ç”¨æµ‹è¯•è§†é¢‘ï¼Œç¡®ä¿èƒ½æ’­æ”¾
                    duration: "5:30",
                    thumbnail: "https://via.placeholder.com/60x45/4CAF50/FFFFFF?text=é£æ™¯"
                },
                {
                    id: 2,
                    title: "ç¤ºä¾‹è§†é¢‘2 - åŠ¨ç‰©ä¸–ç•Œ",
                    url: "https://v202509.fhbbff.com/20251025/KJSSxEk1/index.m3u8",
                    duration: "10:15",
                    thumbnail: "https://via.placeholder.com/60x45/2196F3/FFFFFF?text=åŠ¨ç‰©"
                },
                {
                    id: 3,
                    title: "ç¤ºä¾‹è§†é¢‘3 - ç§‘æŠ€å‰æ²¿",
                    url: "https://v202509.fhbbff.com/20251023/tc19cBGs/index.m3u8",
                    duration: "7:45",
                    thumbnail: "https://via.placeholder.com/60x45/FF9800/FFFFFF?text=ç§‘æŠ€"
                },
                {
                    id: 4,
                    title: "ç¤ºä¾‹è§†é¢‘4 - éŸ³ä¹MV",
                    url: "https://v202509.fhbbff.com/20251026/C3JARqNJ/index.m3u8",
                    duration: "55:20",
                    thumbnail: "https://via.placeholder.com/60x45/E91E63/FFFFFF?text=éŸ³ä¹"
                },
                {
                    id: 5,
                    title: "ç¤ºä¾‹è§†é¢‘5 - ä½“è‚²é›†é”¦",
                    url: "https://v202509.fhbbff.com/20251026/PbfagE2m/index.m3u8",
                    duration: "58:50",
                    thumbnail: "https://via.placeholder.com/60x45/795548/FFFFFF?text=ä½“è‚²"
                },
                {
                    id: 6,
                    title: "ç¤ºä¾‹è§†é¢‘6 - ç¾é£Ÿåˆ¶ä½œ",
                    url: "https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8",
                    duration: "12:30",
                    thumbnail: "https://via.placeholder.com/60x45/607D8B/FFFFFF?text=ç¾é£Ÿ"
                }
            ];
            
            // åˆå§‹åŒ–HLSæ’­æ”¾å™¨
            let hls;
            
            // æ¸²æŸ“è§†é¢‘åˆ—è¡¨
            function renderVideoList() {
                videoItemsContainer.innerHTML = '';
                
                videoList.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';
                    videoItem.dataset.id = video.id;
                    
                    // å¦‚æœè§†é¢‘å·²æ’­æ”¾è¿‡ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°
                    if (playedVideos.has(video.id)) {
                        videoItem.classList.add('played');
                    }
                    
                    videoItem.innerHTML = `
                        <div class="thumb">
                            <img src="${video.thumbnail}" alt="${video.title}">
                        </div>
                        <div class="info">
                            <div class="title">${video.title}</div>
                            <div class="duration">${video.duration}</div>
                        </div>
                    `;
                    
                    videoItem.addEventListener('click', function() {
                        // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°è§‚çœ‹é™åˆ¶
                        if (watchedCount >= 3 && !hasShared) {
                            lockedOverlay.classList.remove('hidden');
                            return;
                        }
                        
                        // ç§»é™¤æ‰€æœ‰activeç±»
                        document.querySelectorAll('.video-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // æ·»åŠ activeç±»åˆ°å½“å‰é¡¹
                        this.classList.add('active');
                        
                        // æ’­æ”¾é€‰ä¸­çš„è§†é¢‘
                        playVideo(video);
                    });
                    
                    videoItemsContainer.appendChild(videoItem);
                });
            }
            
            // æ’­æ”¾è§†é¢‘å‡½æ•°
            function playVideo(video) {
                currentVideoTitle.textContent = video.title;
                currentVideoId = video.id;
                
                // æ˜¾ç¤ºåŠ è½½æç¤º
                videoLoading.classList.remove('hidden');
                
                // å¦‚æœHLSå·²ç»å­˜åœ¨ï¼Œå…ˆé”€æ¯
                if (hls) {
                    hls.destroy();
                }
                
                // åˆå§‹åŒ–HLSæ’­æ”¾å™¨
                if (Hls.isSupported()) {
                    hls = new Hls({
                        enableWorker: false, // åœ¨å¾®ä¿¡ä¸­å¯èƒ½éœ€è¦ç¦ç”¨worker
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    hls.loadSource(video.url);
                    hls.attachMedia(videoPlayer);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        videoLoading.classList.add('hidden');
                        videoPlayer.play().catch(e => {
                            console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’:', e);
                            // åœ¨å¾®ä¿¡ä¸­ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾
                        });
                    });
                    
                    hls.on(HlsEvents.ERROR, function(event, data) {
                        console.error('HLSé”™è¯¯:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.log('ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡æ–°åŠ è½½');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.log('åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.log('ä¸å¯æ¢å¤çš„é”™è¯¯');
                                    videoLoading.classList.add('hidden');
                                    alert('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                                    break;
                            }
                        }
                    });
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    // åŸç”Ÿæ”¯æŒHLSçš„æµè§ˆå™¨ï¼ˆå¦‚Safariï¼‰
                    videoPlayer.src = video.url;
                    videoPlayer.addEventListener('loadedmetadata', function() {
                        videoLoading.classList.add('hidden');
                        videoPlayer.play().catch(e => {
                            console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', e);
                        });
                    });
                } else {
                    // ä¸æ”¯æŒHLSçš„æµè§ˆå™¨
                    videoLoading.classList.add('hidden');
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ’­æ”¾æ­¤è§†é¢‘æ ¼å¼');
                }
                
                // è§†é¢‘å¼€å§‹æ’­æ”¾æ—¶è®¡æ•°
                const playHandler = function() {
                    // åªæœ‰å½“è§†é¢‘æ˜¯ç¬¬ä¸€æ¬¡æ’­æ”¾ä¸”ç”¨æˆ·æœªåˆ†äº«æ—¶æ‰è®¡æ•°
                    if (currentVideoId && !playedVideos.has(currentVideoId) && !hasShared) {
                        playedVideos.add(currentVideoId);
                        watchedCount = playedVideos.size;
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        localStorage.setItem('watchedCount', watchedCount);
                        localStorage.setItem('playedVideos', JSON.stringify([...playedVideos]));
                        
                        updateWatchedCount();
                        updateVideoListDisplay();
                        
                        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°3ä¸ªè§†é¢‘ï¼Œå¦‚æœæ˜¯åˆ™é”å®š
                        if (watchedCount >= 3) {
                            lockedOverlay.classList.remove('hidden');
                            videoPlayer.pause();
                        }
                    }
                    
                    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤è§¦å‘
                    videoPlayer.removeEventListener('play', playHandler);
                };
                
                videoPlayer.addEventListener('play', playHandler);
            }
            
            // æ›´æ–°è§†é¢‘åˆ—è¡¨æ˜¾ç¤º
            function updateVideoListDisplay() {
                document.querySelectorAll('.video-item').forEach(item => {
                    const videoId = parseInt(item.dataset.id);
                    if (playedVideos.has(videoId)) {
                        item.classList.add('played');
                    }
                });
            }
            
            // æ›´æ–°è§‚çœ‹æ¬¡æ•°
            function updateWatchedCount() {
                watchedCountElement.textContent = watchedCount;
            }
            
            // æ˜¾ç¤ºåˆ†äº«é¢æ¿
            showShareBtn.addEventListener('click', function() {
                sharePanel.classList.add('active');
                overlay.classList.add('active');
            });
            
            // è½¬å‘ç»™æœ‹å‹
            shareToFriend.addEventListener('click', function() {
                sharePanel.classList.remove('active');
                shareGuide.classList.add('active');
            });
            
            // åˆ†äº«åˆ°æœ‹å‹åœˆ
            shareToMoments.addEventListener('click', function() {
                sharePanel.classList.remove('active');
                shareGuide.classList.add('active');
            });
            
            // ä¿å­˜åˆ°æ‰‹æœº
            saveToPhone.addEventListener('click', function() {
                // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿé“¾æ¥ç”¨äºä¸‹è½½
                const link = document.createElement('a');
                link.href = 'https://i.ibb.co/Z63h8mck/qrcode.png';
                link.download = 'åˆ†äº«äºŒç»´ç .png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('äºŒç»´ç å·²ä¿å­˜åˆ°æ‰‹æœºç›¸å†Œï¼Œè¯·åˆ†äº«ç»™å¥½å‹');
            });
            
            // æ”¶è—
            collectBtn.addEventListener('click', function() {
                alert('é¡µé¢å·²æ·»åŠ åˆ°æ”¶è—');
            });
            
            // å–æ¶ˆåˆ†äº«
            cancelShare.addEventListener('click', function() {
                sharePanel.classList.remove('active');
                overlay.classList.remove('active');
            });
            
            // å…³é—­æŒ‡å¼•å¹¶è§£é”
            closeGuide.addEventListener('click', function() {
                shareGuide.classList.remove('active');
                overlay.classList.remove('active');
                
                // ç”¨æˆ·å·²ç»åˆ†äº«ï¼Œè§£é”æ–°çš„3ä¸ªè§†é¢‘
                hasShared = true;
                cycleCount++;
                
                // é‡ç½®è§‚çœ‹è®¡æ•°ï¼Œä½†ä¿ç•™å·²æ’­æ”¾è§†é¢‘è®°å½•
                watchedCount = 0;
                
                // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('hasShared', JSON.stringify(hasShared));
                localStorage.setItem('cycleCount', cycleCount);
                localStorage.setItem('watchedCount', watchedCount);
                
                // æ›´æ–°ç•Œé¢
                updateWatchedCount();
                lockedOverlay.classList.add('hidden');
                
                alert(`åˆ†äº«æˆåŠŸï¼å·²è§£é”æ–°çš„3ä¸ªè§†é¢‘ï¼ˆç¬¬${cycleCount+1}å‘¨æœŸï¼‰`);
            });
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­åˆ†äº«é¢æ¿
            overlay.addEventListener('click', function() {
                sharePanel.classList.remove('active');
                shareGuide.classList.remove('active');
                overlay.classList.remove('active');
            });
            
            // åˆå§‹åŒ–
            renderVideoList();
            updateWatchedCount();
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºé”å®šç•Œé¢
            if (watchedCount >= 3 && !hasShared) {
                lockedOverlay.classList.remove('hidden');
            }
            
            // å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šå¤„ç†
            if (/MicroMessenger/i.test(navigator.userAgent)) {
                console.log('å¾®ä¿¡æµè§ˆå™¨ç¯å¢ƒæ£€æµ‹');
                // æ·»åŠ å¾®ä¿¡ç‰¹å®šçš„äº‹ä»¶å¤„ç†
            }
        });
    </script>
</body>
</html>
