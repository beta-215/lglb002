<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>视频播放页</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@8/dist/video-js.min.css" />
<script src="https://cdn.jsdelivr.net/npm/video.js@8/dist/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/videojs-contrib-hls@5.15.0/dist/videojs-contrib-hls.min.js"></script>
<style>
  body {margin: 0;background-color: #000;overflow: hidden;font-family: "Microsoft Yahei", sans-serif;}
  #playerWrapper {position: relative;width: 100vw;height: 100vh;}
  #video {width: 100%;height: 100%;background-color: #000;}
  #cover {position: absolute;width: 100%;height: 100%;object-fit: cover;cursor: pointer;}
  #loading {position: absolute;top: 0;left: 0;width: 100%;height: 100%;display: none;align-items: center;justify-content: center;color: #fff;background: rgba(0,0,0,0.5);font-size: 18px;}
  #qrOverlay {position: absolute;top: 0;left: 0;width: 100%;height: 100%;display: none;flex-direction: column;align-items: center;justify-content: center;background: rgba(0,0,0,0.8);color: #fff;text-align: center;z-index: 99;}
  #qrOverlay img {width: 180px;height: 180px;border-radius: 8px;margin-bottom: 20px;}
  #sharedBtn {background: #ccc;border: none;padding: 10px 25px;font-size: 16px;border-radius: 6px;color: #333;cursor: not-allowed;}
  #sharedBtn.active {background: #00c853;color: #fff;cursor: pointer;}
</style>
</head>
<body>
<div id="playerWrapper">
  <video id="video" class="video-js vjs-default-skin" controls playsinline></video>
  <img id="cover" src="" alt="cover" />
  <div id="loading">加载中...</div>
  <div id="qrOverlay">
    <img src="qr.jpg" alt="二维码" />
    <p id="countdown">请将此二维码分享到微信群或好友</p>
    <button id="sharedBtn">我已分享</button>
  </div>
</div>
<script>
(async function() {
  const video = document.getElementById('video');
  const loading = document.getElementById('loading');
  const cover = document.getElementById('cover');
  const qrOverlay = document.getElementById('qrOverlay');
  const sharedBtn = document.getElementById('sharedBtn');
  const countdownText = document.getElementById('countdown');
  const res = await fetch('links.json');
  const data = await res.json();
  const list = data.videos;
  cover.src = data.cover;
  let watchedList = JSON.parse(localStorage.getItem('watchedList') || '[]');
  let current = parseInt(localStorage.getItem('videoIndex') || 0);
  let sharedDone = localStorage.getItem('sharedDone') === 'true';
  let shareCycle = parseInt(localStorage.getItem('shareCycle') || 0);
  cover.onclick = () => {cover.style.display = 'none';startPlay();};
  video.addEventListener('play', () => {
    const currentSrc = list[current];
    if (!watchedList.includes(currentSrc)) {
      watchedList.push(currentSrc);
      localStorage.setItem('watchedList', JSON.stringify(watchedList));
      if ((watchedList.length - shareCycle * 3) >= 3 && !sharedDone) {
        showShareOverlay();video.pause();
      }
    }
  });
  function startPlay() {
    if (current >= list.length) current = 0;
    const src = list[current];
    video.src = src;
    loading.style.display = 'flex';
    video.load();
    video.oncanplay = () => {loading.style.display = 'none';video.play().catch(()=>{});};
    video.onended = () => {
      current++;localStorage.setItem('videoIndex', current);
      if ((watchedList.length - shareCycle * 3) >= 3 && !sharedDone) {showShareOverlay();}
      else {startPlay();}
    };
  }
  function showShareOverlay() {
    qrOverlay.style.display = 'flex';sharedBtn.disabled = true;sharedBtn.classList.remove('active');
    let timeLeft = 10;
    countdownText.innerHTML = `请将此二维码分享到微信群或好友<br>${timeLeft} 秒后可点击解锁`;
    const timer = setInterval(() => {
      timeLeft--;countdownText.innerHTML = `请将此二维码分享到微信群或好友<br>${timeLeft} 秒后可点击解锁`;
      if (timeLeft <= 0) {
        clearInterval(timer);sharedBtn.disabled = false;sharedBtn.classList.add('active');
        countdownText.innerHTML = `请点击“我已分享”按钮以继续播放`;
      }
    }, 1000);
  }
  sharedBtn.onclick = () => {
    if (sharedBtn.disabled) return;
    qrOverlay.style.display = 'none';sharedDone = true;shareCycle++;
    localStorage.setItem('sharedDone', 'true');localStorage.setItem('shareCycle', shareCycle);
    startPlay();
  };
  if (sharedDone && (watchedList.length - shareCycle * 3) < 3) {
    localStorage.setItem('sharedDone', 'false');sharedDone = false;
  }
})();
</script>
</body>
</html>